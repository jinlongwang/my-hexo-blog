<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Simple is better than complex">
<meta property="og:type" content="website">
<meta property="og:title" content="wangjinlong&#39;s blog">
<meta property="og:url" content="http://wangjinlong.vip/index.html">
<meta property="og:site_name" content="wangjinlong&#39;s blog">
<meta property="og:description" content="Simple is better than complex">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="wangjinlong&#39;s blog">
<meta name="twitter:description" content="Simple is better than complex">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wangjinlong.vip/">





  <title>wangjinlong's blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wangjinlong's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/09/01/gunicorn-Master-Worker2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/01/gunicorn-Master-Worker2/" itemprop="url">gunicorn源码分析:Master-Worker模式（2）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-01T00:02:00+08:00">
                2018-09-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="gunicorn源码分析-Master-Worker模式（2）"><a href="#gunicorn源码分析-Master-Worker模式（2）" class="headerlink" title="gunicorn源码分析:Master-Worker模式（2）"></a>gunicorn源码分析:Master-Worker模式（2）</h1><h2 id="worker代码"><a href="#worker代码" class="headerlink" title="worker代码"></a>worker代码</h2><p>看一下worker类的实现<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    SIGNALS = map(</span><br><span class="line">        <span class="keyword">lambda</span> x: getattr(signal, <span class="string">"SIG%s"</span> % x),</span><br><span class="line">        <span class="string">"HUP QUIT INT TERM TTIN TTOU USR1"</span>.split()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, workerid, ppid, socket, app)</span>:</span></span><br><span class="line">        self.id = workerid  <span class="comment"># 顺序号1，2，3...</span></span><br><span class="line">        self.ppid = ppid.   <span class="comment"># 子进程的pid</span></span><br><span class="line">        fd, tmpname = tempfile.mkstemp() </span><br><span class="line">        self.tmp = os.fdopen(fd, <span class="string">"r+b"</span>)</span><br><span class="line">        self.tmpname = tmpname</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># prevent inherientence</span></span><br><span class="line">        self.close_on_exec(socket)</span><br><span class="line">        self.close_on_exec(fd)</span><br><span class="line">        </span><br><span class="line">        self.socket = socket</span><br><span class="line">        self.address = socket.getsockname()</span><br><span class="line">        </span><br><span class="line">        self.app = app</span><br><span class="line">        self.alive = <span class="keyword">True</span></span><br><span class="line">        </span><br><span class="line">        self.log = logging.getLogger(__name__)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/09/01/2018-09-02-gunicron/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/01/2018-09-02-gunicron/" itemprop="url">gunicorn源码分析:Master-Worker模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-01T00:02:00+08:00">
                2018-09-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="gunicorn源码分析-Master-Worker模式"><a href="#gunicorn源码分析-Master-Worker模式" class="headerlink" title="gunicorn源码分析:Master-Worker模式"></a>gunicorn源码分析:Master-Worker模式</h1><p>最近阅读了gunicron的源码。 gunicron的工作模式采用Master-Worker， 提前fork出配置文件中配置数量的worker进程（prefork），这些worker进程同事监听这master进程的一个socket. worker进程响应用户请求。master进程通过各种信号量管理者worker进程。整个实现非常的巧妙，很多细节值得学习。</p>
<p>我把代码回退到较早的一个版本的提交，主要想看清楚整个处理架构。<br>commit_id: <code>ec301fd43d26207ff0dd9e06925882bc017dc866</code></p>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><pre><code>.
├── LICENSE
├── Manifest.in
├── README.rst
├── bin
│   ├── gunicorn  #程序入口
│   └── gunicorn_django # django_app
├── examples
│   └── test.py # test app符合wsgi协议
├── gunicorn # 核心目录
│   ├── __init__.py 
│   ├── arbiter.py  # master进程启动文件
│   ├── http
│   │   ├── __init__.py
│   │   ├── iostream.py
│   │   ├── request.py # 处理http请求
│   │   ├── response.py # 处理http请求
│   ├── util.py
│   ├── worker.py  # woker进程核心文件
└── setup.py
</code></pre><h2 id="代码启动"><a href="#代码启动" class="headerlink" title="代码启动"></a>代码启动</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arbiter = gunicorn.Arbiter((opts.host, opts.port), opts.workers, app)</span><br><span class="line">arbiter.run()</span><br></pre></td></tr></table></figure>
<p>构造Arbiter类，传入监听端口，worker数量，调用run方法启动。项目启动后能看到3个进程（设置worker数量为2)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">501 75763 72171   0 Fri11PM ??         0:00.58 /System/Library/Frameworks/Python.framework/Versions/2.7/Resources/Python.app/Contents/MacOS/Python /Users/wangjinlong/Documents/jinlong/code/github/gunicorn/bin/gunicorn --workers=2 examples/test:app</span><br><span class="line">501 75764 75763   0 Fri11PM ??         0:00.11 /System/Library/Frameworks/Python.framework/Versions/2.7/Resources/Python.app/Contents/MacOS/Python /Users/wangjinlong/Documents/jinlong/code/github/gunicorn/bin/gunicorn --workers=2 examples/test:app</span><br><span class="line">501 75765 75763   0 Fri11PM ??         0:00.11 /System/Library/Frameworks/Python.framework/Versions/2.7/Resources/Python.app/Contents/MacOS/Python /Users/wangjinlong/Documents/jinlong/code/github/gunicorn/bin/gunicorn --workers=2 examples/test:app</span><br></pre></td></tr></table></figure>
<p>可以看到两个<code>75763</code>fork出两个子进程<code>75764</code>和<code>75765</code>. <code>75763</code>是master进程，<br>子进程为worker进程。</p>
<h1 id="master类代码"><a href="#master类代码" class="headerlink" title="master类代码"></a>master类代码</h1><h2 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h2><p>arbiter类图如下</p>
<p><img src="/img/gunicron/arbiter.png" alt="image"></p>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>master类的构造方法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Arbiter</span><span class="params">(object)</span>:</span></span><br><span class="line">    </span><br><span class="line">    LISTENER = <span class="keyword">None</span> <span class="comment"># 后面赋值为监听的地址和端口构造的socket对象（127.0.0.1:8000）</span></span><br><span class="line">    WORKERS = &#123;&#125;    </span><br><span class="line">    PIPE = []       <span class="comment"># 父子进程通过管道通讯？没看出来具体作用。知识点见: https://www.cnblogs.com/kunhu/p/3608109.html</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># I love dyanmic languages</span></span><br><span class="line">    SIG_QUEUE = []  <span class="comment"># 信号量队列</span></span><br><span class="line">    SIGNALS = map(</span><br><span class="line">        <span class="keyword">lambda</span> x: getattr(signal, <span class="string">"SIG%s"</span> % x),</span><br><span class="line">        <span class="string">"CHLD HUP QUIT INT TERM TTIN TTOU USR1 USR2 WINCH"</span>.split()</span><br><span class="line">    )</span><br><span class="line">    SIG_NAMES = dict(</span><br><span class="line">        (getattr(signal, name), name[<span class="number">3</span>:].lower()) <span class="keyword">for</span> name <span class="keyword">in</span> dir(signal)</span><br><span class="line">        <span class="keyword">if</span> name[:<span class="number">3</span>] == <span class="string">"SIG"</span> <span class="keyword">and</span> name[<span class="number">3</span>] != <span class="string">"_"</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, address, num_workers, modname)</span>:</span></span><br><span class="line">        self.address = address                <span class="comment"># 地址 127.0.0.1:8080</span></span><br><span class="line">        self.num_workers = num_workers        <span class="comment"># woker数量，不用说了一版为cpu核数</span></span><br><span class="line">        self.modname = modname                <span class="comment"># app名字，app为符合wsgi协议的python web代码</span></span><br><span class="line">        self.timeout = <span class="number">30</span>                     <span class="comment"># 超时时间</span></span><br><span class="line">        self.reexec_pid = <span class="number">0</span>                   <span class="comment"># 子进程ID</span></span><br><span class="line">        self.pid = os.getpid()                <span class="comment"># master 进程ID</span></span><br><span class="line">        self.init_signals()                   <span class="comment"># 初始化信号量对应操作</span></span><br><span class="line">        self.listen(self.address)             <span class="comment"># 构造socket对象，并把LISTENER赋值为这个对象</span></span><br><span class="line">        log.info(<span class="string">"Booted Arbiter: %s"</span> % os.getpid())</span><br></pre></td></tr></table></figure>
<p><code>self.init_signals()</code> 初始化了所有的信号量以及对应操作， master靠信号量来管理worker进程，例如：增加一个worker进程，杀死一个woker进程等等，具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_signals</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.PIPE:   </span><br><span class="line">        map(<span class="keyword">lambda</span> p: p.close(), self.PIPE)</span><br><span class="line">    self.PIPE = pair = os.pipe()</span><br><span class="line">    map(self.set_non_blocking, pair)</span><br><span class="line">    map(<span class="keyword">lambda</span> p: fcntl.fcntl(p, fcntl.F_SETFD, fcntl.FD_CLOEXEC), pair)</span><br><span class="line">    map(<span class="keyword">lambda</span> s: signal.signal(s, self.signal), self.SIGNALS)</span><br></pre></td></tr></table></figure>
<p><code>self.PIPE</code> 没搞清楚到底作用是什么？调试代码发现可能是为了在master进程中，有队PIPE写和读的操作。</p>
<p><code>self.listen</code> 方法主要是构造了socket对象</p>
<p>重点看Arbiter类的run方法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.manage_workers()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sig = self.SIG_QUEUE.pop(<span class="number">0</span>) <span class="keyword">if</span> len(self.SIG_QUEUE) <span class="keyword">else</span> <span class="keyword">None</span></span><br><span class="line">            <span class="keyword">if</span> sig <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                self.sleep()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> sig <span class="keyword">not</span> <span class="keyword">in</span> self.SIG_NAMES:</span><br><span class="line">                log.info(<span class="string">"Ignoring unknown signal: %s"</span> % sig)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            signame = self.SIG_NAMES.get(sig)</span><br><span class="line">            handler = getattr(self, <span class="string">"handle_%s"</span> % signame, <span class="keyword">None</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> handler:</span><br><span class="line">                log.error(<span class="string">"Unhandled signal: %s"</span> % signame)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            log.info(<span class="string">"Handling signal: %s"</span> % signame)</span><br><span class="line">            handler()</span><br><span class="line">            </span><br><span class="line">            self.murder_workers()</span><br><span class="line">            self.reap_workers()</span><br><span class="line">            self.manage_workers()</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            self.stop(<span class="keyword">False</span>)</span><br><span class="line">            sys.exit(<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            log.exception(<span class="string">"Unhandled exception in main loop."</span>)</span><br><span class="line">            self.stop(<span class="keyword">False</span>)</span><br><span class="line">            sys.exit(<span class="number">-1</span>)</span><br><span class="line">            </span><br><span class="line">    log.info(<span class="string">"Master is shutting down."</span>)</span><br><span class="line">    self.stop()</span><br></pre></td></tr></table></figure>
<p><code>self.manage_workers</code>方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">manage_workers</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(self.WORKERS.keys()) &lt; self.num_workers:</span><br><span class="line">        self.spawn_workers()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> pid, w <span class="keyword">in</span> self.WORKERS.items():</span><br><span class="line">        <span class="keyword">if</span> w.id &gt;= self.num_workers:</span><br><span class="line">            self.kill_worker(pid, signal.SIGQUIT)</span><br></pre></td></tr></table></figure>
<p><code>self.spawn_workers</code>方法就可以看到fork worker的操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn_workers</span><span class="params">(self)</span>:</span></span><br><span class="line">    workers = set(w.id <span class="keyword">for</span> w <span class="keyword">in</span> self.WORKERS.values())</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(self.num_workers):</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> workers:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        worker = Worker(i, self.pid, self.LISTENER, self.modname)</span><br><span class="line">        pid = os.fork()</span><br><span class="line">        <span class="keyword">if</span> pid != <span class="number">0</span>:</span><br><span class="line">            self.WORKERS[pid] = worker</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process Child</span></span><br><span class="line">        worker_pid = os.getpid()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            log.info(<span class="string">"Worker %s booting"</span> % worker_pid)</span><br><span class="line">            worker.run()</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> SystemExit:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            log.exception(<span class="string">"Exception in worker process."</span>)</span><br><span class="line">            sys.exit(<span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            worker.tmp.close()</span><br><span class="line">            log.info(<span class="string">"Worker %s exiting."</span> % worker_pid)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/08/24/go的内存管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/24/go的内存管理/" itemprop="url">go的内存管理（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-24T18:45:00+08:00">
                2018-08-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="go的内存管理"><a href="#go的内存管理" class="headerlink" title="go的内存管理"></a>go的内存管理</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/08/23/2018-08-23-inlfuxd3/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/23/2018-08-23-inlfuxd3/" itemprop="url">inlfuxdb源码分析-写入分析（三）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T18:45:00+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="inlfuxdb源码分析-写入分析（三）"><a href="#inlfuxdb源码分析-写入分析（三）" class="headerlink" title="inlfuxdb源码分析-写入分析（三）"></a>inlfuxdb源码分析-写入分析（三）</h1><p>写TSM文件源码分析：<br>从单测用例  $GOPATH/influxdata/influxdb/tsdb/engine/tsm1/writer_test.go#TestTSMWriter_Write_Single开始跟代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestTSMWriter_Write_Single</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		   <span class="comment">//创建空文件夹，使用了ioutil.TempDir("", "tsm1-test”)，会根据两个参数随机生成文件夹</span></span><br><span class="line">		   dir := MustTempDir()</span><br><span class="line">		   <span class="comment">//函数运行完，删除该文件夹</span></span><br><span class="line">		   <span class="keyword">defer</span> os.RemoveAll(dir)</span><br><span class="line">		   <span class="comment">//调用ioutil.TempFile(dir, "tsm1test”)，返回临时文件</span></span><br><span class="line">		   f := MustTempFile(dir)</span><br><span class="line">		   <span class="comment">//构建TSMWriter对象， 所有关于tsm文件的写操作全由这个对象完成</span></span><br><span class="line">		   w, err := tsm1.NewTSMWriter(f)</span><br><span class="line">		   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		      t.Fatalf(<span class="string">"unexpected error creating writer: %v"</span>, err)</span><br><span class="line">		   &#125;</span><br><span class="line">		   . . .</span><br></pre></td></tr></table></figure>
<p>我们来分析一下TSMWriter这个类</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> tsmWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">	   wrapped io.Writer  <span class="comment">//这个不用说了， 任何实现了io.Writer接口的对象</span></span><br><span class="line">	   w       *bufio.Writer <span class="comment">//Writer implements buffering for an io.Writer object，一个带buffering的io.Writer对象</span></span><br><span class="line">	   index   IndexWriter   <span class="comment">//索引数据，IndexWriter是一个接口， 具体的实现类为 directIndex见下文</span></span><br><span class="line">	   n       <span class="keyword">int64</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	writer.<span class="keyword">go</span>#<span class="number">240</span> </span><br><span class="line">	<span class="comment">// directIndex is a simple in-memory index implementation for a TSM file.  The full index</span></span><br><span class="line">	<span class="comment">// must fit in memory.</span></span><br><span class="line">	<span class="keyword">type</span> directIndex <span class="keyword">struct</span> &#123;</span><br><span class="line">	   mu     sync.RWMutex</span><br><span class="line">	   size   <span class="keyword">uint32</span></span><br><span class="line">	   blocks <span class="keyword">map</span>[<span class="keyword">string</span>]*indexEntries</span><br><span class="line">	&#125;</span><br><span class="line">	这个结构为了后面writeIndex准备</span><br><span class="line">	</span><br><span class="line">	Reader.<span class="keyword">go</span>#<span class="number">1342</span></span><br><span class="line">	<span class="keyword">type</span> indexEntries <span class="keyword">struct</span> &#123;</span><br><span class="line">	   Type    <span class="keyword">byte</span></span><br><span class="line">	   entries []IndexEntry</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	writer.<span class="keyword">go</span>#<span class="number">172</span></span><br><span class="line">	<span class="keyword">type</span> IndexEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">	   <span class="comment">// The min and max time of all points stored in the block.</span></span><br><span class="line">	   MinTime, MaxTime <span class="keyword">int64</span></span><br><span class="line">	</span><br><span class="line">	   <span class="comment">// The absolute position in the file where this block is located.</span></span><br><span class="line">	   Offset <span class="keyword">int64</span></span><br><span class="line">	</span><br><span class="line">	   <span class="comment">// The size in bytes of the block in the file.</span></span><br><span class="line">	   Size <span class="keyword">uint32</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// NewTSMWriter returns a new TSMWriter writing to w.</span></span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">NewTSMWriter</span><span class="params">(w io.Writer)</span> <span class="params">(TSMWriter, error)</span></span> &#123;</span><br><span class="line">	   index := &amp;directIndex&#123;</span><br><span class="line">	      blocks: <span class="keyword">map</span>[<span class="keyword">string</span>]*indexEntries&#123;&#125;,</span><br><span class="line">	   &#125;</span><br><span class="line">	</span><br><span class="line">	   <span class="keyword">return</span> &amp;tsmWriter&#123;wrapped: w, w: bufio.NewWriterSize(w, <span class="number">1024</span>*<span class="number">1024</span>), index: index&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>看一下TSMWriter的write方法</p>
<pre><code>// Write writes a new block containing key and values.
func (t *tsmWriter) Write(key string, values Values) error {
   //传入key和values，values对象我们后面再分析
   if len(key) &gt; maxKeyLength {
      return ErrMaxKeyLengthExceeded
   }

   // Nothing to write
   if len(values) == 0 {
      return nil
   }

   // Write header only after we have some data to write.
   // 先写入头信息
   if t.n == 0 {
      if err := t.writeHeader(); err != nil {
         return err
      }
   }

   // 写入body信息，这里可以对照上文中给出的数据结构来看
   block, err := values.Encode(nil)
   if err != nil {
      return err
   }

   blockType, err := BlockType(block)
   if err != nil {
      return err
   }

   var checksum [crc32.Size]byte
   binary.BigEndian.PutUint32(checksum[:], crc32.ChecksumIEEE(block))

   _, err = t.w.Write(checksum[:])
   if err != nil {
      return err
   }

   n, err := t.w.Write(block)
   if err != nil {
      return err
   }
   n += len(checksum)

   // Record this block in index
   // 写入directIndex
   t.index.Add(key, blockType, values[0].UnixNano(), values[len(values)-1].UnixNano(), t.n, uint32(n))

   // Increment file position pointer
   t.n += int64(n)
   return nil
}


//t.index.Add方法具体实现
func (d *directIndex) Add(key string, blockType byte, minTime, maxTime int64, offset int64, size uint32) {
   d.mu.Lock()
   defer d.mu.Unlock()

   // d.block是 map[string]*indexEntries,最终大概的结构是
   // ex： key是cpu，{cpu: [{‘MinTime’: xxx, ‘MaxTime’,:xxx, ‘offset’: xxx, ’size’: xxx}]， ‘mem’: ...}
   entries := d.blocks[key]
   if entries == nil {
      entries = &amp;indexEntries{
         Type: blockType,
      }
      d.blocks[key] = entries
      // size of the key stored in the index
      d.size += uint32(2 + len(key))

      // size of the count of entries stored in the index
      d.size += indexCountSize
   }
   //entries []IndexEntry
   entries.entries = append(entries.entries, IndexEntry{
      MinTime: minTime,
      MaxTime: maxTime,
      Offset:  offset,
      Size:    size,
   })

   // size of the encoded index entry
   d.size += indexEntrySize
}
</code></pre><p>下面我们看看tsmWriter的writeIndex方法的实现</p>
<pre><code>func (t *tsmWriter) WriteIndex() error {
   indexPos := t.n

   if t.index.KeyCount() == 0 {
      return ErrNoValues
   }

   // Write the index
   if _, err := t.index.WriteTo(t.w); err != nil {
      return err
   }

   var buf [8]byte
   binary.BigEndian.PutUint64(buf[:], uint64(indexPos))

   // Write the index index position
   _, err := t.w.Write(buf[:])
   return err
}
</code></pre><p>主要看t.index.WriteTo(t.w) 这个方法<br>要记住之前index的结构</p>
<p> <img src="/img/influxdb/tsm_index.png" alt="image"></p>
<pre><code>type directIndex struct {
   mu     sync.RWMutex
   size   uint32
   blocks map[string]*indexEntries
}
这个结构为了后面writeIndex准备

Reader.go#1342
type indexEntries struct {
   Type    byte
   entries []IndexEntry
}

writer.go#172
type IndexEntry struct {
   // The min and max time of all points stored in the block.
   MinTime, MaxTime int64

   // The absolute position in the file where this block is located.
   Offset int64

   // The size in bytes of the block in the file.
   Size uint32
}
//把用到的几个对象放在上面，以便看的更清楚一些



func (d *directIndex) WriteTo(w io.Writer) (int64, error) {
   d.mu.RLock()
   defer d.mu.RUnlock()

   // Index blocks are writtens sorted by key
   // keys: [‘cpu’, ‘mem’, xxxx]
   keys := make([]string, 0, len(d.blocks))
   for k := range d.blocks {
      keys = append(keys, k)
   }
   // 字典排序
   sort.Strings(keys)

   var (
      n   int
      err error
      buf [5]byte
      N   int64
   )

   // For each key, individual entries are sorted by time
   for _, key := range keys {
      entries := d.blocks[key]

      if entries.Len() &gt; maxIndexEntries {
         return N, fmt.Errorf(&quot;key &apos;%s&apos; exceeds max index entries: %d &gt; %d&quot;, key, entries.Len(), maxIndexEntries)
      }
      sort.Sort(entries)
      //2字节的key len
      binary.BigEndian.PutUint16(buf[0:2], uint16(len(key)))
      //1字节的key Type
      buf[2] = entries.Type
      //2字节的内容长度
      binary.BigEndian.PutUint16(buf[3:5], uint16(entries.Len()))

      // Append the key length and key
      if n, err = w.Write(buf[0:2]); err != nil {
         return int64(n) + N, fmt.Errorf(&quot;write: writer key length error: %v&quot;, err)
      }
      N += int64(n)

      if n, err = io.WriteString(w, key); err != nil {
         return int64(n) + N, fmt.Errorf(&quot;write: writer key error: %v&quot;, err)
      }
      N += int64(n)

      // Append the block type and count
      if n, err = w.Write(buf[2:5]); err != nil {
         return int64(n) + N, fmt.Errorf(&quot;write: writer block type and count error: %v&quot;, err)
      }
      N += int64(n)

      // Append each index entry for all blocks for this key
      var n64 int64
      //在主要看这个方法
      if n64, err = entries.WriteTo(w); err != nil {
         return n64 + N, fmt.Errorf(&quot;write: writer entries error: %v&quot;, err)
      }
      N += n64

   }
   return N, nil
}


func (a *indexEntries) WriteTo(w io.Writer) (total int64, err error) {
   var buf [indexEntrySize]byte
   var n int

   for _, entry := range a.entries {
      entry.AppendTo(buf[:])
      n, err = w.Write(buf[:])
      total += int64(n)
      if err != nil {
         return total, err
      }
   }

   return total, nil
}

func (e *IndexEntry) AppendTo(b []byte) []byte {
   if len(b) &lt; indexEntrySize {
      if cap(b) &lt; indexEntrySize {
         b = make([]byte, indexEntrySize)
      } else {
         b = b[:indexEntrySize]
      }
   }

   binary.BigEndian.PutUint64(b[:8], uint64(e.MinTime))
   binary.BigEndian.PutUint64(b[8:16], uint64(e.MaxTime))
   binary.BigEndian.PutUint64(b[16:24], uint64(e.Offset))
   binary.BigEndian.PutUint32(b[24:28], uint32(e.Size))

   return b
}
</code></pre><p>至此写入数据已经完成，我们可以查看tsm产生的文件</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/08/20/2018-08-20-influxdb-2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/20/2018-08-20-influxdb-2/" itemprop="url">inlfuxdb源码分析-文件结构（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-20T18:45:00+08:00">
                2018-08-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="inlfuxdb源码分析-文件结构（二）"><a href="#inlfuxdb源码分析-文件结构（二）" class="headerlink" title="inlfuxdb源码分析-文件结构（二）"></a>inlfuxdb源码分析-文件结构（二）</h1><h2 id="存储数据结构"><a href="#存储数据结构" class="headerlink" title="存储数据结构"></a>存储数据结构</h2><p>influxdb的存储引擎为改进<code>lsm tree</code>， 叫做<code>tsm tree</code>.<br>关于<code>lsm tree</code>其核心的思想就是：将对数据的修改增量保持在内存中，达到指定的大小限制后将这些修改操作批量写入磁盘。 改随机写为顺序写，对写多读少的场景又很强的优化效果</p>
<p>参考:</p>
<p><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.44.2782&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener">lsm tree 论文</a></p>
<p><a href="http://blog.fatedier.com/2016/06/15/learn-lsm-tree/" target="_blank" rel="noopener">lsm存储模型</a></p>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><p><img src="/img/influxdb/file_struct.png" alt="image"></p>
<h2 id="tsm文件"><a href="#tsm文件" class="headerlink" title="tsm文件"></a>tsm文件</h2><p>一个tsm文件的构成：Header， Blocks， Index，Footer</p>
<p><img src="/img/influxdb/tsm.png" alt="image"></p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>4bytes Magic number, 1byte Version</p>
<pre><code>MagicNumber uint32 = 0x16D116D1
Version byte = 1
</code></pre><p><img src="/img/influxdb/tsm_header.png" alt="image"></p>
<h3 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks:"></a>Blocks:</h3><p>Block 由CRC校验4个字节， 已经Data 字节组成。 Data 的数据解压后的格式为 8 字节的时间戳以及紧跟着的 value，value 根据类型的不同，会占用不. 同大小的空间，其中 string 为不定长，会在数据开始处存放长度，这一点和 WAL 文件中的格式相同。</p>
<p><img src="/img/influxdb/tsm_blocks.png" alt="image"></p>
<h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p> Index 存放的是前面 Blocks 里内容的索引。索引条目的顺序是先按照 key 的字典序排序，再按照 time 排序。InfluxDB 在做查询操作时，可以根据 Index 的信息快速定位到 tsm file 中要查询的 block 的位置</p>
<p> <img src="/img/influxdb/tsm_index.png" alt="image"></p>
<p>查找时， 会根据Key做二分查找， 找到key在block中的偏移，取出数据。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/08/14/2018-08-14-infuxdb1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/14/2018-08-14-infuxdb1/" itemprop="url">inlfuxdb源码分析（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-14T18:45:00+08:00">
                2018-08-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="inlfuxdb源码分析（一）"><a href="#inlfuxdb源码分析（一）" class="headerlink" title="inlfuxdb源码分析（一）"></a>inlfuxdb源码分析（一）</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>不多说了， 需要对时序数据有了解参考</p>
<ul>
<li><a href="https://www.influxdata.com/time-series-platform/influxdb/" target="_blank" rel="noopener">官网</a></li>
</ul>
<h2 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h2><h3 id="clone代码"><a href="#clone代码" class="headerlink" title="clone代码"></a>clone代码</h3><p>从github上clone代码到本地<code>$GOPATH/influxdata/influxdb</code></p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p><code>cd $GOPATH/influxdata/influxdb</code></p>
<p><code>go get ./...</code></p>
<p>安装过程中你会发现有问题， 我在master分支和1.4，1.5版本始终没有解决，<br>1.3版本下编译通过。需要根据<code>Godeps</code>文件下的库文件的<code>comment id</code>来切换自己库的相关依赖</p>
<h3 id="编译influxd"><a href="#编译influxd" class="headerlink" title="编译influxd"></a>编译influxd</h3><p><code>cd $GOPATH/influxdata/influxdb/cmd/influxd/</code></p>
<p><code>go build</code></p>
<h3 id="启动可执行文件"><a href="#启动可执行文件" class="headerlink" title="启动可执行文件"></a>启动可执行文件</h3><p><code>./influxd</code></p>
<h2 id="下节将从influxd这个包开始看代码"><a href="#下节将从influxd这个包开始看代码" class="headerlink" title="下节将从influxd这个包开始看代码"></a>下节将从influxd这个包开始看代码</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/05/26/2018-05-26-code-review/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/26/2018-05-26-code-review/" itemprop="url">如何提高代码质量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-26T23:00:00+08:00">
                2018-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何提高代码质量"><a href="#如何提高代码质量" class="headerlink" title="如何提高代码质量"></a>如何提高代码质量</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li>目标： 远景上下达成一致。 并非为了增加工作量，为了提高代码质量已经代码水平。</li>
<li>客观： 用数据说话， 多维度的数据支撑</li>
<li>措施可落地， 方式大家都认可</li>
<li>工具化，自动化（review， sonar）</li>
</ol>
<h2 id="标准"><a href="#标准" class="headerlink" title="标准"></a>标准</h2><ol>
<li>度量代码质量的指标是什么（千行代码严重错误率，千行代码缺陷）</li>
<li>标准如何确定（参考业界标准， 公司内其他业务线标准？）</li>
</ol>
<h2 id="反馈"><a href="#反馈" class="headerlink" title="反馈"></a>反馈</h2><ol>
<li>关键指标趋势（是否有好转）</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://tech.meituan.com/Quality_Operation_In_ZCM.html" target="_blank" rel="noopener">质量运营在智能支付业务测试中的初步实践</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/05/26/2018-05-26-git-flow/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/26/2018-05-26-git-flow/" itemprop="url">git flow</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-26T20:00:00+08:00">
                2018-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>这几年一直在用git， 但是一直感觉一直没用好， 原因还是多人协助的大型项目比较少。最近在做前后端分离的项目， 多人协作，并且接入公司发布系统，这个时候统一的git工作流就显得非常重要了。 问题如下</p>
<ol>
<li>在什么分支进行开发？</li>
<li>用什么分支部署到测试环境？</li>
<li>用什么分支部署到线上环境？</li>
<li>改bug时候怎么处理？</li>
<li>pull request怎么用？</li>
</ol>
<p>带着这些问题， 对使用最广泛的git flow进行了学习， 规范大家的工作流。</p>
<h2 id="git-flow"><a href="#git-flow" class="headerlink" title="git flow"></a>git flow</h2><h3 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h3><ol>
<li>master 主分支，永远保证稳定的发布版本， 长期存在</li>
<li>develop 开发分支， 日常开发的最新代码，会比master分支的内容多，长期存在</li>
<li>feature 功能分支， 开发新功能时从develop拉取， 开发完成merge回develop, 删除该分支</li>
<li>release 发布分支，在上线条件ok之后，从develop拉出，之后不做任何新功能添加，只修改bug，最后release就要合并回master, 同时合回develop</li>
<li>bugfix，修复分支， 从master， develop拉出，修完同样合回去，删除掉</li>
</ol>
<h2 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h2><p>假设现在有个<a href="mailto:`git@github.com" target="_blank" rel="noopener">`git@github.com</a>:test/portal.git`的项目，clone下来，下面开始开发</p>
<ol>
<li><p>拉出开发分支</p>
<pre><code>git branch develop
git push origin develop
</code></pre><p> 现在已经有了master和develop两个长期存在的分支</p>
</li>
</ol>
<ol start="2">
<li><p>我要开发新功能了new_job了！</p>
<pre><code>git checkout -b feature_new_job develop 
git add
git commit -m &quot;awsome work&quot;
git push
</code></pre><p>从develop创建新的分支， 名字叫feature_new_job， 然后都在上面提交</p>
</li>
</ol>
<ol start="3">
<li><p>新功能new_job已经开发完了！</p>
<pre><code>    git checkout develop.
    git pull
    git merge feature_new_job
    git push
    git branch -d feature_new_job

切到develop分支，获取最新代码，合并feature_new_job分支， 提交代码到develop， 删除feature_new_job分支。

在测试环境测试develop分支
</code></pre></li>
</ol>
<ol start="4">
<li><p>准备发版了</p>
<pre><code>git checkout -b release_0.0.1 develop
git push
</code></pre><p>改bug， push。。。改bug， push。</p>
</li>
</ol>
<ol start="5">
<li><p>代码没问题了！！！真的要上线了</p>
<pre><code>git checkout master
git merge release_0.0.1
git push
</code></pre><p> 还要合回到develop分支</p>
<pre><code>git checkout develop
git merge release-0.1.0
git push
git branch -d release-0.1.0
</code></pre></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2018/05/15/2018-05-15-what-is-ops/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/15/2018-05-15-what-is-ops/" itemprop="url">对运维的思考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-15T18:45:00+08:00">
                2018-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="对运维的一些思考"><a href="#对运维的一些思考" class="headerlink" title="对运维的一些思考"></a>对运维的一些思考</h1><ol>
<li>随着网站流量越来越大，故障发生的频率也越来越高。怎么能减少故障的时间呢，加快故障处理速度？ </li>
<li>当业务发生问题之后， 运维能做什么？</li>
<li>运维在平时除了日常的变更工作，还有做什么工作帮助业务发现问题，解决问题？</li>
<li>运维开发团队又能为业务和运维提供哪些服务，解放运维的工作， 帮助业务减少问题的出现？</li>
</ol>
<p>对以上问题，在总结故障之后，得出自己的一些思考</p>
<h2 id="故障前"><a href="#故障前" class="headerlink" title="故障前"></a>故障前</h2><p>总结之前的故障， 发现更多的情况是业务方并没有按照运维提供的标准做事。<br>我的理解，运维在日常的变更工作之外，最重要的事情就是<code>制定标准</code>。只有标准化一切，否则自动化运维更是无从谈起<br>具体的标准有哪些呢？</p>
<ul>
<li>硬件规格</li>
<li>操作系统</li>
<li>基础配置</li>
<li>中间件版本，使用规范</li>
<li>代码规范</li>
<li>部署路径</li>
<li>日志路径</li>
<li>如何监控，监控哪些指标（非常重要）</li>
<li>….</li>
</ul>
<p>等等等等，只要能想到可以标准化的事情，全部做到有标准，有规范。对我们的团队来说可能是处在有标准，但是没有和业务共识。所以如何将标准落地，如何拉进运维和业务开发的距离非常重要。个人认为， 运维一定要离业务很近， 和业务开发穿一条裤子，才能保证所运维业务的稳定，以及更加快速的处理问题。 这就像业务开发必须离需求很近， 运维开发要离运维很近一个道理</p>
<p>故障前运维还能做什么？ 比如，故障的预案， 有了预案就需要故障的演练， 甚至在新业务上线之前， 如何评估容量，压力。这些都需要运维从自己的多年经验的角度和开发一起做这些事。</p>
<h2 id="故障中"><a href="#故障中" class="headerlink" title="故障中"></a>故障中</h2><p>当故障发生之时，运维又能做什么呢？ 协助开发排查问题， 用自己的经验通过蛛丝马迹快速定位问题。用各种强大的自动化系统如日志， 监控，tracing等系统快速解决问题。 </p>
<p>不过我认为， 除非真的是运维本身的问题，比如网络，服务器磁盘等问题， 如果真的是业务开发自己的代码bug，在故障中，查找问题之时，运维还是很难帮助到开发排查问题的。</p>
<p>真正要做到的还是在故障前落实标准</p>
<h2 id="故障后"><a href="#故障后" class="headerlink" title="故障后"></a>故障后</h2><p>我觉得不论运维还是开发，对每一次故障都要有刨根问底儿的精神。故障的原因究竟是什么？ 为什么会发生？ 如何避免？ 以后遇到的解决办法是什么？开发和运维要做到一起复盘一遍。不是为了甩锅，是为了让系统更健壮，故障不在发生。</p>
<p>这里我觉得有两个关键点很重要：</p>
<ol>
<li><p>用事实说话：分析故障原因不能靠猜， 要用事实来说话， 当时每个节点的日志是什么？ 对应故障发生时间有什么变更操作，记录是什么？等等</p>
</li>
<li><p>故障报告很重要：详细的故障报告书写，沉淀成为知识库。对后人，对自己都是有很大的帮助</p>
</li>
</ol>
<h2 id="运维开发能做啥？"><a href="#运维开发能做啥？" class="headerlink" title="运维开发能做啥？"></a>运维开发能做啥？</h2><p>运维开发团队做什么事情才能算是真正帮助到运维了， 才能算是一个有意义有成就感的团队，我的理解有如下几点</p>
<h3 id="对标准"><a href="#对标准" class="headerlink" title="对标准"></a>对标准</h3><p>通过一系列的自动化运维系统，帮助运维落地标准。 比如集中的PAAS层约束中间件使用标准， 发布系统约束开发代码标准， 完备的监控系统（很重要）约束监控规范等等</p>
<h3 id="对运维的日常工作"><a href="#对运维的日常工作" class="headerlink" title="对运维的日常工作"></a>对运维的日常工作</h3><p>开发团队的存在就是为了解放运维的生产力，不管哪个系统我自己总结就是需要有<code>流畅的体验</code>，说起来简单，但是要是想让运维，甚至开发们有这种体验，做起来还是有很长的路要走的</p>
<h3 id="对外提供的服务"><a href="#对外提供的服务" class="headerlink" title="对外提供的服务"></a>对外提供的服务</h3><p>运维开发团队和运维也会对开发去提供基础的一些服务，比如PAAS层的一些服务， 发布等等。 运维的系统可能量不会很大但对于这些系统来说以下两点尤为重要</p>
<ol>
<li>高效问题的提供服务</li>
<li>准确的数据</li>
</ol>
<p>每个系统做到以上两点以及可以及格了</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>说了几次监控很重要，因为他是真的很重要， 我们把监控叫做运维之眼， 运维能不能睡好觉， 监控至关重要。 这里只想说一点， 每个业务最好去定义自己的关键指标， 而关键指标必须保证能告警。 这个指标可能是url， 可能是qps。总之需要运维和业务一起商量确定</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wangjinlong.vip/2016/09/25/2016-09-25-react/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinlong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangjinlong's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/25/2016-09-25-react/" itemprop="url">React learning</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-25T22:50:00+08:00">
                2016-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>事情要从 <a href="https://github.com/ElemeFE/element" target="_blank" rel="noopener">饿了么这个前端库</a> 说起。偶然在微博上看到eleme团队开源了这个叫<code>element</code>的前端库， 看下源码是基于<code>vue</code>的。顺着评论又看到了阿里的 <a href="http://ant.design/" target="_blank" rel="noopener">ant.design</a>, 感觉各种漂亮。如果以后能在自己的项目中统一使用这一套，那逼格杠杠的。而且阿里云之类的中后台貌似都是用的这一套。<br>看了一下介绍：</p>
<p>1.Designed as Ant Design，提炼和服务企业级中后台产品的交互语言和视觉风格。</p>
<p>2.React Component 基础上精心封装的高质量 UI 组件。</p>
<p>3.基于 npm + webpack + babel 的工作流，支持 ES2015 和 TypeScript。</p>
<p><code>vue</code>之前看过，而且实际项目中也用到了，只是没有用得到组件这块的内容。<code>React</code>刚出来的时候看了一下， 当时感觉比较复杂就放弃看了。没想到现在发展的这么好。要想用起<code>antd</code>这一套，看来要从<code>React</code>入手</p>
<p>###感悟</p>
<p><code>React</code>两天看下来感觉还可以。 但毕竟不是专业前端人员， 而且这几年的前端发展感觉太快了，已经打破的我工作之初对html, css, js的理解。 现在搞得什么gulp, webpack， scss，less，还有<code>Weex</code>, <code>Redux</code>这些东西，我真的是有些晕菜了。。。</p>
<p>###目标</p>
<p>现在的目标就是把<code>antd</code>搞起来试一下！ </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="jinlong">
            
              <p class="site-author-name" itemprop="name">jinlong</p>
              <p class="site-description motion-element" itemprop="description">Simple is better than complex</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jinlongwang" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:superrz@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wangjinlong.vip/" title="Title" target="_blank">Title</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jinlong</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
